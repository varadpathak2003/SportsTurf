<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slot Management</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/slot.css}">
    <!-- Toastr CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</head>
<body>
    <div class="container">
        <h2><i class="fas fa-calendar-alt"></i> Slot Management</h2>
        
        <div class="form-group">
            <label for="ground"><i class="fas fa-map-marker-alt"></i> Select Ground:</label>
            <select id="ground">
                <option value="">--Select Ground--</option>
                <option th:each="ground : ${grounds}" 
                        th:value="${ground.id}" 
                        th:text="${ground.name}"
                        th:data-opening-time="${ground.openingTime}"
                        th:data-closing-time="${ground.closingTime}"></option>
            </select>
        </div>

        <div class="time-display">
            <p><b>Opening Time:</b> <span id="openingTime">N/A</span> <b>Closing Time:</b> <span id="closingTime">N/A</span></p>
        </div>

        <div class="form-group">
            <label for="breakTime"><i class="fas fa-clock"></i> Break Time:</label>
            <input type="text" id="breakTime" placeholder="12:00 - 15:00">
        </div>

        <div class="form-group">
            <label for="slotHours"><i class="fas fa-hourglass-half"></i> Duration (hours):</label>
            <input type="number" id="slotHours" min="1" value="1">
        </div>

        <div class="form-group">
            <label for="basePrice"><i class="fas fa-tag"></i> Base Price:</label>
            <input type="number" id="basePrice" min="0" value="0">
        </div>

        <div class="form-group">
            <label for="weekendExtra"><i class="fas fa-star"></i> Weekend Extra:</label>
            <input type="number" id="weekendExtra" min="0" value="0">
        </div>

        <h3><i class="fas fa-list-alt"></i> Available Slots</h3>
        <div id="slotContainer"></div>

        <button onclick="submitSlots()">
            <i class="fas fa-save"></i>
            Save Slots
        </button>
    </div>

    <script>
    let selectedSlots = new Set();

    $(document).ready(function () {
        $("#ground").change(updateGroundTimesAndSlots);
        $("#breakTime, #slotHours").on("input", generateSlots);
    });

    function updateGroundTimesAndSlots() {
        const selectedOption = $(this).find("option:selected");
        $("#openingTime").text(selectedOption.data("opening-time") || "N/A");
        $("#closingTime").text(selectedOption.data("closing-time") || "N/A");
        generateSlots();
        selectedSlots.clear();
    }

    function generateSlots() {
        const openingTime = $("#openingTime").text().trim();
        const closingTime = $("#closingTime").text().trim();
        const breakTime = $("#breakTime").val().trim();
        const slotHours = parseInt($("#slotHours").val());

        if (!openingTime || openingTime === "N/A" || !closingTime || closingTime === "N/A" || isNaN(slotHours) || slotHours <= 0) {
            $("#slotContainer").html("<p>Please select a ground first and set valid duration</p>");
            return;
        }

        const slots = calculateSlots(openingTime, closingTime, breakTime, slotHours);
        renderSlots(slots);
    }

    function renderSlots(slots) {
        $("#slotContainer").empty();
        
        if (slots.length === 0) {
            $("#slotContainer").append("<p>No available slots</p>");
            return;
        }

        slots.forEach(slot => {
            const slotElement = $(`
                <div class="slot-card" data-start="${slot.start}" data-end="${slot.end}">
                    ${slot.start} - ${slot.end}
                </div>
            `).click(toggleSlotSelection);
            
            $("#slotContainer").append(slotElement);
        });
    }

    function toggleSlotSelection() {
        $(this).toggleClass("selected");
        const slotId = `${$(this).data("start")}-${$(this).data("end")}`;
        selectedSlots.has(slotId) ? selectedSlots.delete(slotId) : selectedSlots.add(slotId);
    }

    // Keep calculateSlots, convertToMinutes, convertToTime functions as they are

    function submitSlots() {
        const groundId = $("#ground").val();
        const breakTime = $("#breakTime").val().trim();
        const basePrice = parseFloat($("#basePrice").val()) || 0;
        const weekendPrice = basePrice + (parseFloat($("#weekendExtra").val()) || 0);

        if (!validateSubmission(groundId, breakTime)) return;

        const slotsData = {
            groundId: groundId,
            slots: getSelectedSlotsData(basePrice, weekendPrice, breakTime),
        };

        submitToServer(slotsData);
    }

    function validateSubmission(groundId, breakTime) {
        if (!groundId) {
            toastr.error("Please select a ground");
            return false;
        }
        if (breakTime && !/^([01]\d|2[0-3]):[0-5]\d - ([01]\d|2[0-3]):[0-5]\d$/.test(breakTime)) {
            toastr.error("Use HH:mm - HH:mm format for break time");
            return false;
        }
        return true;
    }

    function getSelectedSlotsData(basePrice, weekendPrice, breakTime) {
        return $(".slot-card.selected").map(function() {
            return {
                startTime: $(this).data("start"),
                endTime: $(this).data("end"),
                price: basePrice,
                weekendPrice: weekendPrice,
                availability: true,
                breakTime: breakTime
            };
        }).get();
    }

    function submitToServer(slotsData) {
        if (slotsData.slots.length === 0) {
            toastr.error("Please select at least one slot");
            return;
        }

        fetch("/admin/slots/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(slotsData)
        })
        .then(handleResponse)
        .catch(handleError);
    }

    function handleResponse(response) {
        if (response.ok) {
            return response.text().then(msg => toastr.success(msg || "Slots saved successfully"));
        }
        response.text().then(msg => toastr.error(msg || "Error saving slots"));
    }

    function handleError(error) {
        toastr.error("Network error: " + error.message);
    }

    // Toastr configuration (keep only one)
    toastr.options = {
        closeButton: true,
        progressBar: true,
        positionClass: "toast-top-right",
        preventDuplicates: true,
        showDuration: 300,
        hideDuration: 1000,
        timeOut: 5000
    };
    </script>
</body>
</html>